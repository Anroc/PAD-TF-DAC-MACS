// http://your.jenkins.host/scriptApproval/
import groovy.json.JsonOutput

SOURCE_DIR = "./implementation/tfdacmacs"
CRYPTO_RESOURCES_DIR = "./implementation/tfdacmacs/crypto/src/main/resources"

node {
    try {
        checkout scm

        stage('gradle testClasses') {
                // sh('printenv')
                dir (SOURCE_DIR) {
                sh('./gradlew crypto:clean crypto:assemble crypto:testClasses')
            }
        }

        stage('prepare native libs') {
            sh('mkdir -p ' + CRYPTO_RESOURCES_DIR)
            dir (CRYPTO_RESOURCES_DIR) {
                sh('ln -f -s /usr/local/lib/libjpbc-pbc.so libjpbc-pbc.so')
            }
        }

        stage('gradle crypto:benchmark') {
            // sh('printenv')
            dir (SOURCE_DIR) {
                try {
                    sh('./gradlew crypto:benchmark')
                } finally {
                    step([$class: 'JUnitResultArchiver', testResults: 'crypto/build/test-results/benchmark/*.xml'])
                    archiveArtifacts artifacts: "**/*.csv", fingerprint: true
                }
            }
        }

        currentBuild.result = 'SUCCESS'
    } catch (e) {
        currentBuild.result = 'FAILURE'
        throw e
    }
}
